<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Orders</title>
  <style>
    body { font-family:sans-serif }
    .container { max-width:800px; margin:auto; padding:20px }
    .order { border:1px solid #ccc; padding:15px; margin-bottom:20px }
    .items th, .items td { padding:6px 10px; text-align:left }
    .btn { padding:4px 8px; cursor:pointer; margin-top:10px }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>My Orders</h1>
    <div id="ordersContainer">Loading...</div>
  </div>

  <script>
    const gun = Gun(['https://gun-manhattan.herokuapp.com/gun']);
    const username = localStorage.getItem("macx_loggedInUser");
    const ordersRef = username && gun.get("macx_orders").get(username);

    if (!username) {
      alert("Please login first.");
      window.location.href = "login.html";
    }

    function renderOrders() {
      const c = document.getElementById("ordersContainer");
      c.innerHTML = "";

      ordersRef.map().once((o, id) => {
        if (!o || !o.items) return;

        const itemsTable = o.items.map(i => {
          const p = parseInt(i.price);
          const q = parseInt(i.quantity);
          const s = p * q;
          return `<tr>
            <td>${i.productName}</td>
            <td>₹${p}</td>
            <td>${q}</td>
            <td>₹${s}</td>
          </tr>`;
        }).join("");

        const shipping = o.shipping || {};
        const info = `
          <strong>Ship To:</strong> ${shipping.name}<br>
          ${shipping.address}, ${shipping.country} - ${shipping.pincode}<br>
          <strong>Phone:</strong> ${shipping.phone} <br>
          <strong>Email:</strong> ${shipping.email}
        `;

        const status = o.status || "Pending";
        let actionBtn = "";
        if (status === "Pending") {
          actionBtn = `<button class="btn" onclick="updateStatus('${id}', 'Cancelled')">Cancel Order</button>`;
        } else if (status === "Paid") {
          actionBtn = `<span style="color:green">Paid</span>`;
        }

        const html = `
          <div class="order" id="order-${id}">
            <h3>Order #${id}</h3>
            <p><strong>Status:</strong> ${status}</p>
            <table class="items" border="1" cellspacing="0">
              <tr><th>Product</th><th>Price</th><th>Qty</th><th>Subtotal</th></tr>
              ${itemsTable}
            </table>
            <p><strong>Total:</strong> ₹${(o.total || 0)}</p>
            <p>${info}</p>
            ${actionBtn}
          </div>
        `;

        c.innerHTML += html;
      });
    }

    function updateStatus(id, newStatus) {
      ordersRef.get(id).put({ status: newStatus });
      gun.get("admin_orders").get(id).put({ status: newStatus });
      alert("Status updated");
      renderOrders();
    }

    renderOrders();
  </script>
</body>
</html>
