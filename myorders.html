<!-- myorders.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Orders</title>
  <style>
    .container { max-width:800px; margin:auto; padding:20px; font-family:sans-serif }
    .order { border:1px #ccc solid; margin-bottom:20px; padding:15px }
    .order h3 { margin-top:0 }
    .items td { padding:5px 10px }
    .btn { padding:5px 10px; margin-right:8px; cursor:pointer }
    .login-status { float:right; color:green; font-weight:bold; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>My Orders <span class="login-status" id="userDisplay"></span></h1>
    <div id="ordersContainer">Loading orders‚Ä¶</div>
  </div>

  <script>
    const gun = Gun(['https://gun-manhattan.herokuapp.com/gun']);
    const username = localStorage.getItem("macx_loggedInUser");
    const ordersRef = gun.get("macx_orders").get(username);

    if (!username) {
      alert("Please login first");
      window.location.href = "login.html";
    }

    document.getElementById("userDisplay").textContent = `Welcome, ${username}`;

    function renderOrders() {
      const container = document.getElementById("ordersContainer");
      container.innerHTML = "";

      ordersRef.map().on((order, id) => {
        if (!order || !order.items) {
          const old = document.getElementById("ord-" + id);
          if (old) old.remove();
          return;
        }

        let el = document.getElementById("ord-" + id);
        if (!el) {
          el = document.createElement("div");
          el.id = "ord-" + id;
          el.className = "order";
          container.appendChild(el);
        }

        const rows = order.items.map(i => {
          const p = parseInt(i.price)||0;
          const q = parseInt(i.quantity)||1;
          const sub = (p*q).toLocaleString();
          return `<tr><td>${i.productName}</td><td>‚Çπ${p}</td><td>${q}</td><td>‚Çπ${sub}</td></tr>`;
        }).join("");

        const s = order.shipping || {};
        const status = order.status || "Pending";
        let actions = "";
        if (status === "Pending") {
          actions = `<button class="btn" onclick="cancelOrder('${id}')">Cancel</button>`;
        }
        if (status === "Delivered" || status === "Cancelled") {
          actions += `<button class="btn" onclick="deleteOrder('${id}')">Remove</button>`;
        }

        el.innerHTML = `
          <h3>Order #${id}</h3>
          <p><strong>Status:</strong> ${status}</p>
          <table class="items" border="1"><tr><th>Product</th><th>Price</th><th>Qty</th><th>Subtotal</th></tr>${rows}</table>
          <p><strong>Total:</strong> ‚Çπ${(order.total||0).toLocaleString()}</p>
          <p><strong>Shipping:</strong> ${s.name}, ${s.address}, ${s.country}, ${s.pincode} | üìû ${s.phone} | ‚úâÔ∏è ${s.email}</p>
          ${actions}
        `;
      });
    }

    function cancelOrder(id) {
      ordersRef.get(id).put({ status: "Cancelled" });
    }
    function deleteOrder(id) {
      ordersRef.get(id).put(null);
    }

    renderOrders();
  </script>
</body>
</html>
