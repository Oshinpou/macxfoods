<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MACX Cart</title>
  <link rel="stylesheet" href="style.css" />
  <script defer src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
</head>
<body>
  <div class="container">
    <h1>Your Cart</h1>
    <div id="cartItems"></div>
    <h2 id="grandTotal">Grand Total: ₹0</h2>

    <h3>Shipping Details</h3>
    <form id="shippingForm">
      <input type="text" id="customerName" placeholder="Full Name" required><br>
      <input type="tel" id="customerPhone" placeholder="Phone (+91XXXXXXXXXX)" required><br>
      <input type="email" id="customerEmail" placeholder="Email" required><br>
      <textarea id="shippingAddress" placeholder="Shipping Address" required></textarea><br>
      <input type="text" id="country" placeholder="Country" required><br>
      <input type="text" id="pincode" placeholder="Pincode" required><br>
      <button type="submit">Create Order & Pay</button>
    </form>
  </div>

  <script>
    const username = localStorage.getItem("macx_loggedInUser");
    const gun = Gun();
    const cartRef = gun.get("macx_cart").get(username);
    const orderRef = gun.get("macx_orders").get(username);
    const cartItemsDiv = document.getElementById("cartItems");
    const grandTotalEl = document.getElementById("grandTotal");
    let grandTotal = 0;
    let items = [];

    cartRef.map().once((data, id) => {
      if (!data) return;
      const div = document.createElement("div");
      const total = data.price * data.quantity;
      grandTotal += total;
      items.push({...data, id});
      div.innerHTML = `
        <p><strong>${data.productName}</strong> - ₹${data.price} x ${data.quantity}</p>
        <button onclick="deleteItem('${id}')">Delete</button>
      `;
      cartItemsDiv.appendChild(div);
      grandTotalEl.textContent = `Grand Total: ₹${grandTotal}`;
    });

    function deleteItem(id) {
      cartRef.get(id).put(null);
      window.location.reload();
    }

    document.getElementById("shippingForm").addEventListener("submit", (e) => {
      e.preventDefault();
      if (!username) return alert("Login first");

      const name = document.getElementById("customerName").value;
      const phone = document.getElementById("customerPhone").value;
      const email = document.getElementById("customerEmail").value;
      const address = document.getElementById("shippingAddress").value;
      const country = document.getElementById("country").value;
      const pincode = document.getElementById("pincode").value;

      const orderDetails = {
        items,
        name,
        phone,
        email,
        address,
        country,
        pincode,
        grandTotal,
        status: "Pending",
        paymentStatus: "Paid",
        timestamp: Date.now()
      };

      const orderId = Date.now().toString();
      orderRef.get(orderId).put(orderDetails);

      cartRef.map().once((_, id) => cartRef.get(id).put(null));
      alert("Order placed successfully!");
      window.location.href = "myorders.html";
    });
  </script>
</body>
</html>
