<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MACX Cart</title>
  <link rel="stylesheet" href="style.css">
  <script defer src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
</head>
<body>
  <div class="container">

    <!-- ✅ Login Status -->
    <div id="notLoggedIn" style="display: none;">
      <h2>You are not logged in.</h2>
      <button id="loginRedirectBtn">Login First</button>
    </div>
    <div id="loggedInSection" style="display: none;">
      <h1 id="userDisplay">Welcome, User</h1>
      <button id="logoutBtn">Logout</button>
    </div>

    <!-- ✅ Cart Items -->
    <div id="cartSection" style="display: none;">
      <h2>Your Cart</h2>
      <div id="cartItems"></div>
      <h3 id="grandTotal">Grand Total: ₹0</h3>

      <!-- ✅ Shipping Form -->
      <h2>Shipping Details</h2>
      <form id="shippingForm">
        <input type="text" id="name" placeholder="Full Name" required><br>
        <input type="tel" id="phone" placeholder="Phone Number" required><br>
        <input type="email" id="email" placeholder="Email" required><br>
        <input type="text" id="address" placeholder="Shipping Address" required><br>
        <input type="text" id="country" placeholder="Country" required><br>
        <input type="text" id="pincode" placeholder="PIN Code" required><br>
        <button type="submit">Place Order</button>
      </form>
    </div>
  </div>

  <script>
    const username = localStorage.getItem("macx_loggedInUser");
    const gun = Gun();
    const cartRef = gun.get("macx_cart").get(username);
    const ordersRef = gun.get("macx_orders").get(username);
    const adminRef = gun.get("admin_orders");

    const userDisplay = document.getElementById("userDisplay");
    const loggedInSection = document.getElementById("loggedInSection");
    const notLoggedIn = document.getElementById("notLoggedIn");
    const loginRedirectBtn = document.getElementById("loginRedirectBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const cartSection = document.getElementById("cartSection");

    if (username) {
      if (userDisplay) userDisplay.textContent = `Welcome, ${username}`;
      loggedInSection.style.display = "block";
      notLoggedIn.style.display = "none";
      cartSection.style.display = "block";
      if (logoutBtn) {
        logoutBtn.onclick = () => {
          localStorage.removeItem("macx_loggedInUser");
          window.location.reload();
        };
      }
    } else {
      loggedInSection.style.display = "none";
      notLoggedIn.style.display = "block";
      cartSection.style.display = "none";
      if (loginRedirectBtn) {
        loginRedirectBtn.onclick = () => {
          window.location.href = "login.html";
        };
      }
    }

    let total = 0;

    function renderCart() {
      const container = document.getElementById("cartItems");
      container.innerHTML = "";
      total = 0;

      cartRef.map().once((item, id) => {
        if (!item || !item.productName) return;

        const div = document.createElement("div");
        div.innerHTML = `
          <img src="${item.image}" width="80">
          <p>${item.productName} - ₹${item.price} x ${item.quantity}</p>
          <button onclick="removeItem('${id}')">Remove</button>
        `;
        container.appendChild(div);

        total += item.price * item.quantity;
        document.getElementById("grandTotal").textContent = `Grand Total: ₹${total}`;
      });
    }

    function removeItem(id) {
      cartRef.get(id).put(null);
      setTimeout(renderCart, 500);
    }

    document.getElementById("shippingForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const orderId = Date.now().toString();
      const shipping = {
        name: document.getElementById("name").value,
        phone: document.getElementById("phone").value,
        email: document.getElementById("email").value,
        address: document.getElementById("address").value,
        country: document.getElementById("country").value,
        pincode: document.getElementById("pincode").value,
        total,
        status: "Pending",
        paid: "Yes",
        timestamp: Date.now()
      };

      const orderItems = [];
      cartRef.map().once((item, id) => {
        if (!item || !item.productName) return;
        orderItems.push(item);
      });

      setTimeout(() => {
        ordersRef.get(orderId).put({ shipping, items: orderItems });
        adminRef.get(orderId).put({ shipping, items: orderItems });
        alert("Order placed successfully!");
        cartRef.map().once((data, id) => cartRef.get(id).put(null));
        renderCart();
      }, 500);
    });

    renderCart();
  </script>
</body>
</html>
