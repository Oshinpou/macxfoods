<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MACX Cart</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
 <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<script src="macx-commerce.js"></script>
  
  <style>
    body { background: #111; color: #fff; font-family: Arial; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 10px; border: 1px solid #333; }
    button { padding: 5px 10px; }
  </style>
</head>
<body>
  <div id="loginStatusWrapper"></div>

  <h1>Your Cart</h1>
  <table id="cartTable">
    <thead>
      <tr>
        <th>Product</th><th>Price</th><th>Qty</th><th>Total</th><th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2 id="grandTotal">Grand Total: ₹0</h2>
  <button onclick="placeOrder()">Place Order</button>

  <script src="login-status.js"></script>
  <script>
    fetch('login-status.html').then(r => r.text()).then(html => {
      document.getElementById('loginStatusWrapper').innerHTML = html;
      initializeLoginStatusUI();
      loadCart();
    });

  // ─── STEP 1: Make Qty Editable ─────────────────────────────────────────
  // 1. Change your loadCart() so Qty is an <input> and rows carry data-index
  function loadCart() {
    const user = localStorage.getItem("macx_loggedInUser");
    if (!user) return;
    const cart = JSON.parse(localStorage.getItem(`macx_cart_${user}`)) || [];
    const tbody = document.querySelector("#cartTable tbody");
    tbody.innerHTML = "";

    let total = 0;
    if (cart.length === 0) {
      tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px;">
        Your bag is feeling lonely!
      </td></tr>`;
      document.getElementById("grandTotal").textContent = `Grand Total: ₹0`;
      return;
    }

    cart.forEach((item, i) => {
      const itemTotal = item.price * item.quantity;
      total += itemTotal;
      tbody.innerHTML += `
        <tr data-index="${i}">
          <td>${item.name}</td>
          <td>₹${item.price}</td>
          <td>
            <input class="qty-input" 
                   type="number" 
                   min="1" 
                   value="${item.quantity}" 
                   style="width:50px">
          </td>
          <td>₹${itemTotal}</td>
          <td><button class="delete-btn">Delete</button></td>
        </tr>`;
    });
    document.getElementById("grandTotal").textContent = `Grand Total: ₹${total}`;
  }

  // STEP 1B: Update helper
  function updateItem(index, newQty) {
    const user = localStorage.getItem("macx_loggedInUser");
    let cart = JSON.parse(localStorage.getItem(`macx_cart_${user}`)) || [];
    cart[index].quantity = newQty;
    saveCart(cart);
    loadCart();
  }

  function deleteItem(index) {
    const user = localStorage.getItem("macx_loggedInUser");
    let cart = JSON.parse(localStorage.getItem(`macx_cart_${user}`)) || [];
    cart.splice(index, 1);
    saveCart(cart);
    loadCart();
  }

  // ─── STEP 2: Event Delegation ──────────────────────────────────────────
  document.querySelector('#cartTable tbody')
    .addEventListener('click', e => {
      const tr = e.target.closest('tr[data-index]');
      if (!tr) return;
      const idx = +tr.dataset.index;

      if (e.target.matches('.delete-btn')) {
        deleteItem(idx);
      }
    });

  document.querySelector('#cartTable tbody')
    .addEventListener('change', e => {
      if (e.target.matches('.qty-input')) {
        const tr = e.target.closest('tr[data-index]');
        const idx = +tr.dataset.index;
        const qty = Math.max(1, +e.target.value);
        updateItem(idx, qty);
      }
    });

  // ─── STEP 3: Real-Time Sync with GunDB ─────────────────────────────────
  // (Optional—only if you want cross-device sync)
  const gun = Gun(); // assumes <script src="gun.js"> loaded
  function saveCart(cart) {
    // localStorage & Gun
    const user = localStorage.getItem("macx_loggedInUser");
    localStorage.setItem(`macx_cart_${user}`, JSON.stringify(cart));
    gun.get('carts').get(user).put({ items: cart });
  }
  // Listen for remote updates
  gun.get('carts').get(localStorage.getItem("macx_loggedInUser"))
    .on(data => {
      if (data && data.items) {
        localStorage.setItem(
          `macx_cart_${localStorage.getItem("macx_loggedInUser")}`,
          JSON.stringify(data.items)
        );
        loadCart();
      }
    });

  // ─── STEP 4: UX POLISH ─────────────────────────────────────────────────
  const placeBtn = document.querySelector("button[onclick='placeOrder()']");
  function togglePlaceBtn() {
    const total = JSON.parse(localStorage.getItem(
      `macx_cart_${localStorage.getItem("macx_loggedInUser")}`
    ) || []).length;
    placeBtn.disabled = total === 0;
  }
  // call from loadCart end
  const origLoadCart = loadCart;
  loadCart = () => { origLoadCart(); togglePlaceBtn(); };

  // ─── STEP 5: Razorpay Integration ───────────────────────────────────────
  function placeOrder() {
    const user = localStorage.getItem("macx_loggedInUser");
    const cart = JSON.parse(localStorage.getItem(`macx_cart_${user}`)) || [];
    if (!cart.length) {
      return alert("Cart is empty");
    }

    // show spinner
    placeBtn.textContent = "Processing…";
    placeBtn.disabled = true;

    // calculate amount
    const amount = cart.reduce((sum, i) => sum + i.price * i.quantity, 0) * 100;

    const options = {
      key: "YOUR_RAZORPAY_KEY",
      amount,
      currency: "INR",
      name: "MACX Store",
      description: "Order Payment",
      handler: function(resp) { finalizeOrder(resp.razorpay_payment_id); },
      modal: { ondismiss() { placeBtn.textContent = "Place Order"; togglePlaceBtn(); } }
    };

    new Razorpay(options).open();
  }

  function finalizeOrder(paymentId) {
    const user = localStorage.getItem("macx_loggedInUser");
    const cart = JSON.parse(localStorage.getItem(`macx_cart_${user}`)) || [];

    // Server-side validation would go here (verify paymentId, amount, etc.)
    const orders = JSON.parse(localStorage.getItem(`macx_orders_${user}`)) || [];
    orders.push({
      orderId: `MACX-${Date.now()}`,
      paymentId,
      items: cart,
      status: "Payment Done",
      date: new Date().toLocaleString()
    });
    localStorage.setItem(`macx_orders_${user}`, JSON.stringify(orders));
    localStorage.removeItem(`macx_cart_${user}`);

    alert("Payment successful! Redirecting to your orders…");
    window.location.href = "myorders.html";
  }

  // ─── STEP 6: Input & XSS SAFETY ────────────────────────────────────────
  // Always use createElement/textContent when rendering user data server-side.
  // Here, since we control `item.name`, verify it contains only safe chars or escape.
  // Optionally run:
  function sanitize(str) {
    return str.replace(/[&<>"']/g, c => 
      ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])
    );
  }
  // Then in loadCart: use sanitize(item.name) instead of raw ${item.name}.

  // ─── INITIAL CALL ─────────────────────────────────────────────────────
  fetch('login-status.html')
    .then(r => r.text())
    .then(html => {
      document.getElementById('loginStatusWrapper').innerHTML = html;
      initializeLoginStatusUI();
      loadCart();
    });

</script>
</body>
</html>
