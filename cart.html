<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MACX Cart</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <style>
    .container { max-width: 800px; margin: auto; padding: 20px; font-family: sans-serif; }
    input, button { margin: 5px 0; padding: 8px; width: 100%; }
    #cartItems div { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; padding: 10px; border-bottom: 1px solid #ccc; }
    img { height: 60px; margin-right: 10px; }
    .product-info { flex-grow: 1; }
    .remove-btn { background-color: crimson; color: white; border: none; padding: 5px 10px; cursor: pointer; }
    .qty-controls { display: flex; align-items: center; gap: 5px; }
    .qty-input { width: 50px; text-align: center; font-size: 16px; padding: 4px; }
    .empty-msg { color: gray; font-style: italic; text-align: center; margin-top: 10px; }
    .item-summary { font-size: 14px; color: #444; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Login Status -->
    <div id="notLoggedIn" style="display:none;">
      <h2>You are not logged in.</h2>
      <button onclick="location.href='login.html'">Login First</button>
    </div><div id="loggedInSection" style="display:none;">
  <h1 id="userDisplay"></h1>
  <button onclick="logout()">Logout</button>

  <h2>Your Cart</h2>
  <div id="cartItems"></div>
  <h3 id="grandTotal">Grand Total: ₹0</h3>

  <h2>Shipping Details</h2>
  <form id="shippingForm">
    <input type="text" id="name" placeholder="Full Name" required><br>
    <input type="tel" id="phone" placeholder="Phone Number" required><br>
    <input type="email" id="email" placeholder="Email" required><br>
    <input type="text" id="address" placeholder="Address" required><br>
    <input type="text" id="country" placeholder="Country" required><br>
    <input type="text" id="pincode" placeholder="PIN Code" required><br>
    <button type="submit">Pay & Place Order</button>
  </form>
</div>

  </div>  <script>
    const username = localStorage.getItem("macx_loggedInUser");
    const gun = Gun();
    const cartRef = gun.get("macx_cart").get(username);
    const ordersRef = gun.get("macx_orders").get(username);
    const adminOrders = gun.get("admin_orders");
    let items = [];

    function logout() {
      localStorage.removeItem("macx_loggedInUser");
      location.reload();
    }

    function renderLoginStatus() {
      if (username) {
        document.getElementById("loggedInSection").style.display = "block";
        document.getElementById("notLoggedIn").style.display = "none";
        document.getElementById("userDisplay").textContent = `Welcome, ${username}`;
        renderCart();
      } else {
        document.getElementById("notLoggedIn").style.display = "block";
        document.getElementById("loggedInSection").style.display = "none";
      }
    }

    function updateGrandTotal() {
      let total = 0;
      items.forEach(item => {
        if (item && item.quantity && item.price) {
          total += item.price * item.quantity;
        }
      });
      document.getElementById("grandTotal").textContent = `Grand Total: ₹${total}`;
    }

    function updateQuantity(id, inputElement) {
      const newQty = parseInt(inputElement.value);
      if (isNaN(newQty) || newQty < 1) return;
      cartRef.get(id).once(data => {
        if (!data) return;
        cartRef.get(id).put({ ...data, quantity: newQty }, () => {
          renderCart();
        });
      });
    }

    function renderCart() {
      const container = document.getElementById("cartItems");
      container.innerHTML = "";
      items = [];

      cartRef.map().once((item, id) => {
        if (!item || !item.productName) return;

        items.push(item);

        const div = document.createElement("div");
        div.innerHTML = `
          <img src="${item.image}" alt="Product">
          <div class="product-info">
            <p><strong>${item.productName}</strong><br>₹${item.price}</p>
            <div class="qty-controls">
              <button onclick="changeQty('${id}', -1)">-</button>
              <input class="qty-input" type="number" value="${item.quantity}" min="1" onchange="updateQuantity('${id}', this)">
              <button onclick="changeQty('${id}', 1)">+</button>
            </div>
            <div class="item-summary">Subtotal: ₹${item.price * item.quantity}</div>
          </div>
          <button class="remove-btn" onclick="removeItem('${id}')">Remove</button>
        `;
        container.appendChild(div);

        updateGrandTotal();
      });

      setTimeout(() => {
        if (container.innerHTML.trim() === "") {
          container.innerHTML = '<p class="empty-msg">Your cart is empty.</p>';
          document.getElementById("grandTotal").textContent = "Grand Total: ₹0";
        }
      }, 1000);
    }

    function changeQty(id, delta) {
      cartRef.get(id).once(data => {
        if (!data) return;
        const newQty = Math.max(1, (data.quantity || 1) + delta);
        cartRef.get(id).put({ ...data, quantity: newQty }, () => {
          renderCart();
        });
      });
    }

    function removeItem(id) {
      cartRef.get(id).put(null);
      setTimeout(renderCart, 300);
    }

    document.getElementById("shippingForm").addEventListener("submit", (e) => {
      e.preventDefault();

      if (items.length === 0) return alert("Cart is empty");

      let total = 0;
      items.forEach(item => {
        if (item && item.quantity && item.price) {
          total += item.price * item.quantity;
        }
      });

      const shipping = {
        name: document.getElementById("name").value,
        phone: document.getElementById("phone").value,
        email: document.getElementById("email").value,
        address: document.getElementById("address").value,
        country: document.getElementById("country").value,
        pincode: document.getElementById("pincode").value,
      };

      const orderId = Date.now().toString();

      const options = {
        key: "YOUR_RAZORPAY_KEY_ID", // Replace with your Razorpay key
        amount: total * 100,
        currency: "INR",
        name: "MACX Cosmetics",
        description: "Order Payment",
        handler: function (response) {
          const order = {
            shipping,
            items,
            total,
            status: "Paid",
            razorpayPaymentId: response.razorpay_payment_id,
            timestamp: Date.now()
          };
          ordersRef.get(orderId).put(order);
          adminOrders.get(orderId).put({ ...order, username });
          cartRef.map().once((data, id) => cartRef.get(id).put(null));
          alert("Order placed successfully!");
          window.location.href = "myorders.html";
        },
        prefill: {
          name: shipping.name,
          email: shipping.email,
          contact: shipping.phone
        },
        theme: { color: "#00c0b5" }
      };

      const rzp = new Razorpay(options);
      rzp.open();
    });

    renderLoginStatus();
  </script></body>
</html>
