<!-- adminorders.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Orders</title>
  <style>
    .container { max-width:800px; margin:auto; padding:20px; font-family:sans-serif }
    .order { border:1px #ccc solid; margin-bottom:20px; padding:15px }
    .order h3 { margin-top:0 }
    .items td { padding:5px 10px }
    .btn { padding:5px 10px; margin-right:8px; cursor:pointer }
    #orderSearch { width:100%; padding:8px; margin-bottom:20px }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Admin Order Management</h1>
    <input type="text" id="orderSearch" placeholder="Search Order ID..." onkeyup="filterOrders()" />
    <div id="adminOrdersContainer">Loading...</div>
  </div>

  <script>
    const gun = Gun(['https://gun-manhattan.herokuapp.com/gun']);
    const adminOrders = gun.get("admin_orders");

    function renderAdminOrders() {
      const container = document.getElementById("adminOrdersContainer");

      adminOrders.map().on((order, id) => {
        if (!order || !order.items) {
          const old = document.getElementById("ord-" + id);
          if (old) old.remove();
          return;
        }

        let el = document.getElementById("ord-" + id);
        if (!el) {
          el = document.createElement("div");
          el.id = "ord-" + id;
          el.className = "order";
          container.appendChild(el);
        }

        const rows = order.items.map(i => {
          const p = parseInt(i.price)||0;
          const q = parseInt(i.quantity)||1;
          const sub = (p*q).toLocaleString();
          return `<tr><td>${i.productName}</td><td>‚Çπ${p}</td><td>${q}</td><td>‚Çπ${sub}</td></tr>`;
        }).join("");

        const s = order.shipping || {};
        const username = order.username || "Unknown";
        const status = order.status || "Pending";
        let actions = "";
        if (status === "Paid") {
          actions = `<button class='btn' onclick="markDelivered('${id}')">Mark Delivered</button>`;
        }
        if (status === "Cancelled" || status === "Delivered") {
          actions += `<button class='btn' onclick="deleteOrder('${id}')">Remove</button>`;
        }

        el.innerHTML = `
          <h3>Order #${id}</h3>
          <p><strong>User:</strong> ${username} | <strong>Status:</strong> ${status}</p>
          <table class="items" border="1"><tr><th>Product</th><th>Price</th><th>Qty</th><th>Subtotal</th></tr>${rows}</table>
          <p><strong>Total:</strong> ‚Çπ${(order.total||0).toLocaleString()}</p>
          <p><strong>Shipping:</strong> ${s.name}, ${s.address}, ${s.country}, ${s.pincode} | üìû ${s.phone} | ‚úâÔ∏è ${s.email}</p>
          ${actions}
        `;
      });
    }

    function markDelivered(id) {
      adminOrders.get(id).put({ status: "Delivered" });
    }
    function deleteOrder(id) {
      adminOrders.get(id).put(null);
    }
    function filterOrders() {
      const val = document.getElementById("orderSearch").value.toLowerCase();
      document.querySelectorAll(".order").forEach(el => {
        el.style.display = el.id.includes(val) ? '' : 'none';
      });
    }

    renderAdminOrders();
  </script>
</body>
</html>
